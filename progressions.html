<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>ã‚³ãƒ¼ãƒ‰é€²è¡Œä¸€è¦§</title>
    <link rel="icon" href="data:," />
    <style>
/* --- CSSï¼ˆè¦‹ãŸç›®ï¼‰ --- */
* {
    box-sizing: border-box;
}
body {
    width: 100%;
    margin: 0;
    padding: 10px;
    font-family: Arial, sans-serif;
    background-color: #f4f4f4;
    color: #333;
    text-align: center;
    min-height: 100vh;
}

#container {
    max-width: 600px;
    margin: 0 auto;
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

h1 {
    color: #0056b3;
    margin-top: 0; 
}

button {
    padding: 8px 12px;
    font-size: 15px;
    cursor: pointer;
    border: none;
    border-radius: 5px;
    background-color: #007bff;
    color: white;
    margin: 3px;
}
button:hover {
    background-color: #0056b3;
}

/* é€²è¡Œä¸€è¦§ã®ã‚¹ã‚¿ã‚¤ãƒ« */
#progression-list {
    list-style: none;
    padding: 0;
    text-align: left;
}

.progression-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #eee;
}

.progression-item:last-child {
    border-bottom: none;
}

.progression-name {
    font-size: 1.1em;
    font-weight: bold;
    color: #333;
}

/* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
#error-container {
    color: red; 
    font-weight: bold; 
    margin-bottom: 10px;
}
    </style>
</head>
<body>
    <div id="container">
        <h1>ğŸ¸ ã‚³ãƒ¼ãƒ‰é€²è¡Œä¸€è¦§</h1>

        <div id="error-container" style="display: none;"></div>

        <ul id="progression-list">
            </ul>
        
        <button onclick="window.location.href='index.html';" style="background-color: #5cb85c; margin-top: 15px;">
            ãƒ¡ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
        </button>
    </div>
    <script>
        // index.htmlã®ãƒ­ã‚¸ãƒƒã‚¯ã‹ã‚‰å¿…è¦ãªè¨­å®šã‚’ã‚³ãƒ”ãƒ¼
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzjGexgyNuyPOp2fNMCMztMa9kiuoO8TmQRT2TeJbnzWb3mpXN0NuO4KAGHrPLKprukaQ/exec'; 
        const CACHE_KEY = 'chordAppCache';
        const CACHE_TTL = 3600000; 

        // index.htmlã¨åŒã˜ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆJSONPï¼‰
        async function fetchDataFromGAS() {
            const cachedData = localStorage.getItem(CACHE_KEY);
            const cachedTimestamp = localStorage.getItem(CACHE_KEY + 'Timestamp');
            const errorContainer = document.getElementById('error-container');

            if (cachedData && cachedTimestamp && (Date.now() - parseInt(cachedTimestamp) < CACHE_TTL)) {
                return JSON.parse(cachedData);
            }
            
            return new Promise((resolve, reject) => {
                const callbackName = 'gasCallback_' + Date.now();
                window[callbackName] = (data) => {
                    delete window[callbackName]; 
                    script.remove(); 
                    if (data.error) {
                        reject(new Error(data.message || data.error));
                        return;
                    }
                    localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                    localStorage.setItem(CACHE_KEY + 'Timestamp', Date.now().toString());
                    resolve(data);
                };

                const script = document.createElement('script');
                script.src = `${GAS_URL}?callback=${callbackName}`; 
                
                script.onerror = () => {
                    delete window[callbackName];
                    script.remove();
                    reject(new Error("GASã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"));
                };
                
                document.head.appendChild(script);
            })
            .catch(error => {
                errorContainer.textContent = `ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}. å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°ä½¿ç”¨ã—ã¾ã™ã€‚`;
                errorContainer.style.display = 'block';

                if (cachedData) {
                    return JSON.parse(cachedData);
                }
                return null;
            });
        }
        
        // é€²è¡Œãƒªã‚¹ãƒˆã®æç”»
        function loadProgressionsList() {
            const listContainer = document.getElementById('progression-list');
            listContainer.innerHTML = '<li class="progression-item">èª­ã¿è¾¼ã¿ä¸­...</li>';

            fetchDataFromGAS().then(data => {
                listContainer.innerHTML = '';
                if (!data || !data.progressions || Object.keys(data.progressions).length === 0) {
                    listContainer.innerHTML = '<li class="progression-item">ã‚³ãƒ¼ãƒ‰é€²è¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</li>';
                    return;
                }

                const allProgressions = data.progressions;
                for (const name in allProgressions) {
                    const chords = allProgressions[name];
                    const listItem = document.createElement('li');
                    listItem.className = 'progression-item';
                    
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'progression-name';
                    // é€²è¡Œåã¨ã‚³ãƒ¼ãƒ‰ã®å†…è¨³ã‚’è¡¨ç¤º
                    nameDiv.innerHTML = `${name}<br><small>(${chords.length}ã‚³ãƒ¼ãƒ‰: ${chords.join(', ')})</small>`;

                    const startButton = document.createElement('button');
                    startButton.textContent = 'â–¶ æ¼”å¥é–‹å§‹';
                    startButton.onclick = () => {
                        // é¸æŠã—ãŸé€²è¡Œåã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã—ã€index.htmlã¸é·ç§»
                        localStorage.setItem('tempProgressionSelection', name);
                        window.location.href = 'index.html';
                    };
                    
                    listItem.appendChild(nameDiv);
                    listItem.appendChild(startButton);
                    listContainer.appendChild(listItem);
                }

            }).catch(error => {
                listContainer.innerHTML = '<li class="progression-item">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</li>';
            });
        }

        document.addEventListener('DOMContentLoaded', loadProgressionsList);
    </script>
</body>
</html>